<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cloudi — Full Cloud MVP (Investor Demo)</title>

<!-- Fonts similar to enterprise cloud UIs -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=IBM+Plex+Sans:wght@300;400;600&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
/* ===== Cloudi V2 — minimal glass iOS-like UI (blue/white) ===== */
:root{
  --bg:#eef6ff;
  --card:#ffffffcc;
  --glass-strong:#ffffffdd;
  --muted:#6b7280;
  --accent:#0b63c6;
  --accent-2:#2b9af3;
  --ok:#16a34a;
  --warn:#f59e0b;
  --danger:#ef4444;
  --radius:16px;
  --card-radius:20px;
  --shadow: 0 12px 40px rgba(11,99,198,0.08);
  --maxw:1200px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;padding:20px;font-family:"Inter", "IBM Plex Sans", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: linear-gradient(180deg,#f5fbff,#eef6ff 40%); color:#071022;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
.app{max-width:var(--maxw);margin:0 auto;}

/* header */
.header{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  margin-bottom:14px;
}
.brand{
  display:flex;flex-direction:column;
}
.h-title{font-size:26px;font-weight:800;letter-spacing:-0.5px}
.h-sub{font-size:13px;color:var(--muted);margin-top:6px}

/* language switch top-right */
.top-actions{display:flex;gap:8px;align-items:center}
.lang-switch{background:transparent;border:0;color:var(--accent);font-weight:700;padding:8px 12px;border-radius:999px;cursor:pointer}
.lang-switch.active{background:rgba(11,99,198,0.12)}

/* controls */
.controls{display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
.btn.secondary{background:#fff;border:1px solid rgba(11,99,198,0.12);color:var(--accent);font-weight:700}
.small{font-size:13px;color:var(--muted)}

/* layout */
.grid{
  display:grid;
  grid-template-columns: 1fr 360px;
  gap:12px;
}
@media(max-width:520px){ .grid{grid-template-columns:1fr} }

/* card */
.card{
  background:var(--card);backdrop-filter: blur(8px); border-radius:var(--card-radius);
  padding:14px; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,0.6);
}

/* forms */
.label{display:block;font-weight:700;margin-bottom:8px}
.input, select, textarea{
  width:100%;padding:12px;border-radius:12px;border:1px solid rgba(11,99,198,0.06);font-size:15px;background:rgba(255,255,255,0.8)
}
.hrow{display:flex;gap:8px;margin-top:10px}
.col{flex:1;min-width:0}

/* summary card */
.kv{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(11,99,198,0.06)}
.kv:last-child{border-bottom:0}

/* DC/nodes */
.dc-grid{display:flex;flex-wrap:wrap;gap:8px}
.dc{width:120px;padding:10px;border-radius:12px;background:rgba(255,255,255,0.65);border:1px solid rgba(11,99,198,0.06);text-align:center}
.node{height:12px;border-radius:6px;background:rgba(11,99,198,0.12);margin:6px 0}
.node.busy{background:var(--ok)}
.node.warn{background:var(--warn)}
.node.err{background:var(--danger)}

/* progress */
.progressOuter{height:18px;background:rgba(11,99,198,0.06);border-radius:12px;overflow:hidden;margin-top:8px}
.progressInner{height:100%;background:var(--accent);width:0;color:#fff;text-align:center;line-height:18px;font-size:13px}

/* tables */
.table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
.table th,.table td{padding:8px;text-align:left;border-bottom:1px solid rgba(11,99,198,0.03)}

/* logs */
.log{background:#071027;color:#e8f2ff;padding:12px;border-radius:12px;max-height:240px;overflow:auto;font-family:var(--mono);font-size:13px}

/* footer small */
.footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}

/* utilities */
.right{text-align:right}
.copybtn{background:transparent;border:1px dashed rgba(11,99,198,0.08);padding:8px;border-radius:10px;cursor:pointer}

/* responsive tweaks */
@media (max-width:520px){
  .h-title{font-size:20px}
  .input{padding:10px}
  .btn{padding:8px 10px}
}
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <div class="header">
    <div class="brand">
      <div class="h-title" id="title">Cloudi — Full Cloud MVP</div>
      <div class="h-sub" id="subtitle">Interactive: Kernel · Smart-Packing · Elastic Scale · ML loop · FinOps · Storage · AI Serving · Monitoring · Security</div>
    </div>

    <div class="top-actions">
      <!-- language toggles visible -->
      <button id="btnEN" class="lang-switch">EN</button>
      <button id="btnRU" class="lang-switch">RU</button>
      <div style="width:10px"></div>
      <button id="btnPreview" class="btn secondary">Preview</button>
      <button id="btnStart" class="btn">Start demo</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: main area -->
    <div>

      <!-- PARAMETERS -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800;font-size:16px" id="paramsTitle">Main parameters</div>
          <div class="small">Baseline microtest runs in browser (non-authoritative)</div>
        </div>

        <div style="margin-top:12px">
          <label class="label" id="lbl_ops">Operations (ops)</label>
          <input id="ops" class="input" type="number" value="1000000000" />

          <div class="hrow" style="margin-top:10px">
            <div class="col">
              <label class="label" id="lbl_nodecap">Node capacity (ops/sec)</label>
              <input id="nodeCap" class="input" type="number" value="200000000" />
            </div>
            <div style="width:120px">
              <label class="label" id="lbl_nodesdc">Nodes / DC</label>
              <input id="nodesPerDC" class="input" type="number" value="4" />
            </div>
          </div>

          <div class="hrow" style="margin-top:10px">
            <div class="col">
              <label class="label" id="lbl_save">Cloudi AI optimization (%)</label>
              <input id="savePct" class="input" type="number" value="30" min="0" max="90"/>
            </div>
            <div style="width:120px">
              <label class="label" id="lbl_markup">Cloudi markup ×</label>
              <input id="markup" class="input" type="number" value="3" step="0.1" min="1" />
            </div>
          </div>

          <div class="hrow" style="margin-top:12px">
            <button id="btnReset" class="btn secondary">Reset</button>
            <button id="btnTheme" class="btn secondary">Theme</button>
            <div style="flex:1"></div>
            <button id="btnCopySummary" class="copybtn">Copy summary</button>
          </div>
        </div>
      </div>

      <!-- Compute / Kernel -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800;font-size:16px" id="computeTitle">Compute Engine · Kernel & Smart-Packing</div>
          <div class="small">Kernel slices tasks into blocks; Dispatcher packs blocks into nodes using smart-packing (ML simulated)</div>
        </div>

        <div style="margin-top:10px" class="hrow">
          <div class="col">
            <label class="label">Block size (ops)</label>
            <input id="blockSize" class="input" type="number" value="1000000" />
          </div>
          <div style="width:160px">
            <label class="label">Node type</label>
            <select id="nodeType" class="input">
              <option value="vcpu">vCPU-standard</option>
              <option value="vopt">vCPU-optimized</option>
              <option value="hpc">HPC</option>
              <option value="gpu">GPU-node</option>
            </select>
          </div>
        </div>

        <div class="hrow" style="margin-top:10px">
          <button id="btnGenMatrix" class="btn secondary">Generate Matrix</button>
          <button id="btnPacking" class="btn secondary">Packing details</button>
          <button id="btnML" class="btn">Start ML loop</button>
        </div>

        <div id="matrixArea" style="margin-top:12px"></div>

        <div style="margin-top:12px">
          <h4 id="packLogTitle">Packing log</h4>
          <pre id="packLog" class="log">Packing log will appear here.</pre>
        </div>
      </div>

      <!-- Infra / Autoscale -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between">
          <div style="font-weight:800;font-size:16px" id="infraTitle">Infrastructure & Elastic Scaling</div>
          <div class="small">Autoscale reacts to predicted load; nodes and DCs visualized</div>
        </div>

        <div id="dcArea" class="dc-grid" style="margin-top:12px"></div>
        <div id="infraStatus" class="small" style="margin-top:8px">—</div>
        <div class="progressOuter"><div id="prog" class="progressInner">0%</div></div>
        <div id="eta" class="small" style="margin-top:8px">ETA: —</div>
      </div>

      <!-- Storage & AI -->
      <div style="display:flex;gap:12px;margin-top:12px">
        <div class="card" style="flex:1">
          <h4 id="storageTitle">Storage · Buckets (S3-like)</h4>
          <div class="small">Create buckets, upload pseudo files, cost/GB/month simulated</div>
          <div class="hrow" style="margin-top:8px">
            <input id="bucketName" class="input" placeholder="bucket-name" />
            <button id="btnCreateBucket" class="btn secondary">Create</button>
          </div>
          <div id="bucketsArea" style="margin-top:10px"></div>
        </div>

        <div class="card" style="width:360px">
          <h4 id="aiTitle">AI Serving · LLM endpoints (simulated)</h4>
          <div class="small">Simulated endpoints, inference cost & latency, autoscaling GPU nodes</div>
          <div style="margin-top:8px">
            <input id="aiPrompt" class="input" placeholder="Enter prompt..." />
            <div class="hrow" style="margin-top:8px">
              <button id="btnAI" class="btn">Infer</button>
              <div style="flex:1"></div>
              <button id="btnAIclear" class="btn secondary">Clear</button>
            </div>
            <div id="aiResp" style="margin-top:10px" class="small">Responses will appear here.</div>
          </div>
        </div>
      </div>

      <!-- FinOps / Comparison -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between">
          <div style="font-weight:800;font-size:16px" id="finopsTitle">FinOps · Cost Control Engine</div>
          <div class="small">Transparent cost model (node + network + monitoring)</div>
        </div>

        <div style="margin-top:8px" class="hrow">
          <div class="col">
            <div class="kv"><div>Node cost / month</div><div id="nodeCostVal">$420</div></div>
            <div class="kv"><div>Other fixed / month</div><div id="otherCostVal">$980</div></div>
          </div>
          <div style="width:320px">
            <div class="kv"><div>Total infra / month</div><div id="infraMonthVal">—</div></div>
            <div class="kv"><div>Total infra / year</div><div id="infraYearVal">—</div></div>
          </div>
        </div>

        <div style="margin-top:8px">
          <label class="label">Comment</label>
          <textarea id="finComment" class="input" rows="2">Cost engine calculates cost/op = infra_month / (effectiveCap * nodes * seconds_per_month).</textarea>
        </div>
      </div>

      <!-- Monitoring / Security / API / ML charts -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800;font-size:16px" id="monitorTitle">Monitoring · Security · API · Charts</div>
          <div class="small">p50/p95/p99, RPS, SLA, API demo</div>
        </div>

        <div style="display:flex;gap:12px;margin-top:10px">
          <div style="flex:1">
            <label class="label">p95 target (ms)</label>
            <input id="p95" class="input" value="250" />
          </div>
          <div style="width:160px">
            <label class="label">RPS</label>
            <input id="rps" class="input" value="100000" />
          </div>
          <div style="width:160px">
            <label class="label">Latency SLA</label>
            <input id="slaInput" class="input" value="1" />
          </div>
        </div>

        <div class="hrow" style="margin-top:8px">
          <button id="btnMetrics" class="btn secondary">Generate metrics</button>
          <button id="btnAnom" class="btn secondary">Simulate anomaly</button>
          <button id="btnResolve" class="btn secondary">Resolve</button>
          <div style="flex:1"></div>
          <button id="btnDownloadJson" class="btn secondary">Download JSON</button>
        </div>

        <div style="display:flex;gap:12px;margin-top:12px">
          <div style="flex:1"><canvas id="cmpChart" height="140"></canvas></div>
          <div style="width:360px">
            <h4 style="margin:0 0 8px 0">SLA log</h4>
            <pre id="slaLog" class="log">SLA/SEC events appear here.</pre>
          </div>
        </div>

      </div>

      <div class="card" style="margin-top:12px">
        <h4>Full technical log</h4>
        <pre id="fullLog" class="log">Ready — press Preview or Start demo.</pre>
      </div>

    </div>

    <!-- RIGHT: summary & comparison (sticky) -->
    <aside>
      <div class="card card-right" style="position:sticky;top:20px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Quick summary</div>
          <div class="small">Live numbers</div>
        </div>

        <div style="margin-top:8px">
          <div class="kv"><div>Node cap</div><div id="val_nodecap">—</div></div>
          <div class="kv"><div>Nodes (raw)</div><div id="val_nodesraw">—</div></div>
          <div class="kv"><div>Nodes (Cloudi)</div><div id="val_nodesopt">—</div></div>
          <div class="kv"><div>Data centers</div><div id="val_dcs">—</div></div>
          <div class="kv"><div>Processing time</div><div id="val_time">—</div></div>
          <div class="kv"><div>Cost / op</div><div id="val_costop">—</div></div>
        </div>

        <div style="margin-top:12px">
          <button id="btnDownloadLog" class="btn secondary" style="width:100%">Download log</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div style="font-weight:800">Competitors comparison</div>
        <table class="table" id="cmpTable">
          <thead><tr><th>Platform</th><th>Cost/op</th><th>Price</th><th>Time(s)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </aside>

  </div>

  <div class="footer">Formulas: nodes_raw = ceil(ops/nodeCap); effectiveCap = nodeCap*(1+savePct/100); nodes_opt = ceil(ops/effectiveCap); time = ops / (effectiveCap * nodes_opt).</div>
</div>

<script>
/* =========================
   Cloudi Full MVP — single file
   — translations (EN/RU)
   — core compute + packing + finops + charts (Chart.js)
   — language toggle visible EN / RU (top-right)
   — clear minimal UI in blue / white
   ========================= */

const SECONDS_PER_MONTH = 30*24*3600;
const DEFAULTS = {
  nodeCost:420, otherCost:980, nodesPerDC:4,
  competitors:{
    AWS:{nodeCap:180000000,nodeCost:500},
    GCP:{nodeCap:190000000,nodeCost:480},
    Azure:{nodeCap:175000000,nodeCost:520},
    NVIDIA:{nodeCap:220000000,nodeCost:1200}
  }
};

/* ---------- Translations ---------- */
const DICT = {
  en: {
    title: "Cloudi — Full Cloud MVP",
    subtitle: "Interactive: Kernel · Smart-Packing · Elastic Scale · ML loop · FinOps · Storage · AI Serving · Monitoring · Security",
    mainParameters: "Main parameters",
    ops: "Operations (ops)",
    nodeCap: "Node capacity (ops/sec)",
    nodesPerDC: "Nodes / DC",
    savePct: "Cloudi AI optimization (%)",
    markup: "Cloudi markup ×",
    reset: "Reset",
    preview: "Preview",
    startDemo: "Start demo",
    computeTitle: "Compute Engine · Kernel & Smart-Packing",
    packLog: "Packing log",
    infraTitle: "Infrastructure & Elastic Scaling",
    storageTitle: "Storage · Buckets (S3-like)",
    aiTitle: "AI Serving · LLM endpoints (simulated)",
    finopsTitle: "FinOps · Cost Control Engine",
    monitoringTitle: "Monitoring · Security · API · Charts",
    generateMetrics: "Generate metrics",
    simulateAnom: "Simulate anomaly",
    resolveAnom: "Resolve",
    downloadJson: "Download JSON",
    quickSummary: "Quick summary",
    copySummary: "Copy summary",
    downloadLog: "Download log",
    nodeCost: "Node cost / month",
    otherCost: "Other fixed / month",
    totalInfraMonth: "Total infra / month",
    totalInfraYear: "Total infra / year"
  },
  ru: {
    title: "Cloudi — Полный Cloud MVP",
    subtitle: "Интерактив: Kernel · Smart-Packing · Elastic Scale · ML loop · FinOps · Storage · AI Serving · Monitoring · Security",
    mainParameters: "Основные параметры",
    ops: "Операции (ops)",
    nodeCap: "Пропускная способность ноды (ops/sec)",
    nodesPerDC: "Нод / ДЦ",
    savePct: "Оптимизация Cloudi AI (%)",
    markup: "Наценка Cloudi ×",
    reset: "Сброс",
    preview: "Превью",
    startDemo: "Запустить демо",
    computeTitle: "Compute Engine · Kernel и Smart-Packing",
    packLog: "Лог паковки",
    infraTitle: "Инфраструктура и Elastic Scaling",
    storageTitle: "Хранилище · Buckets (S3-подобно)",
    aiTitle: "AI Serving · LLM endpoints (симуляция)",
    finopsTitle: "FinOps · Управление затратами",
    monitoringTitle: "Мониторинг · Безопасность · API · Графики",
    generateMetrics: "Сгенерировать метрики",
    simulateAnom: "Симулировать аномалию",
    resolveAnom: "Устранить",
    downloadJson: "Скачать JSON",
    quickSummary: "Краткая сводка",
    copySummary: "Копировать сводку",
    downloadLog: "Скачать лог",
    nodeCost: "Стоимость ноды / мес",
    otherCost: "Прочие расходы / мес",
    totalInfraMonth: "Итого инфра / мес",
    totalInfraYear: "Итого инфра / год"
  }
};

/* current language */
let LANG = 'en';
function t(k){ return DICT[LANG][k] ?? k; }

/* ---------- formatting helpers ---------- */
function fmt(n){ return (typeof n==='number')? n.toLocaleString() : n; }
function money(n){ if(Math.abs(n) < 1e-6) return n.toExponential(3); return '$' + Number(n).toLocaleString(undefined,{maximumFractionDigits:6}); }
function now(){ return new Date().toLocaleTimeString(); }

/* ---------- DOM helpers ---------- */
const $ = id => document.getElementById(id);

/* ---------- core compute logic ---------- */
function readParams(){
  return {
    ops: Math.max(1, Number($('ops').value) || 1),
    nodeCap: Math.max(1, Number($('nodeCap').value) || 200000000),
    nodesPerDC: Math.max(1, Number($('nodesPerDC').value) || DEFAULTS.nodesPerDC),
    savePct: Math.max(0, Math.min(90, Number($('savePct').value) || 30)),
    markup: Math.max(1, Number($('markup').value) || 3),
    blockSize: Math.max(1, Number($('blockSize').value) || 1000000),
    nodeType: $('nodeType').value
  };
}

function compute(params){
  // basic deterministic formulas
  const nodesRaw = Math.max(1, Math.ceil(params.ops / params.nodeCap));
  const effectiveCap = params.nodeCap * (1 + params.savePct/100);
  const nodesOpt = Math.max(1, Math.ceil(params.ops / effectiveCap));
  const dcs = Math.ceil(nodesOpt / params.nodesPerDC);
  const timeRaw = params.ops / (params.nodeCap * nodesRaw);
  const timeOpt = params.ops / (effectiveCap * nodesOpt);
  const infraMonth = nodesOpt * DEFAULTS.nodeCost + DEFAULTS.otherCost;
  const infraYear = infraMonth * 12;
  const opsPerMonth = effectiveCap * nodesOpt * SECONDS_PER_MONTH;
  const costPerOp = infraMonth / Math.max(1, opsPerMonth);
  const pricePerOp = costPerOp * params.markup;
  const totalPrice = pricePerOp * params.ops;
  const blocks = Math.ceil(params.ops / params.blockSize);
  return { nodesRaw, effectiveCap, nodesOpt, dcs, timeRaw, timeOpt, infraMonth, infraYear, costPerOp, pricePerOp, totalPrice, blocks };
}

/* ---------- UI update (live preview) ---------- */
function preview(){
  const p = readParams(); const r = compute(p);
  $('val_nodecap').innerText = fmt(p.nodeCap);
  $('val_nodesraw').innerText = fmt(r.nodesRaw);
  $('val_nodesopt').innerText = fmt(r.nodesOpt);
  $('val_dcs').innerText = fmt(r.dcs);
  $('val_time').innerText = `${r.timeOpt.toFixed(6)} s (Cloudi) · raw ${r.timeRaw.toFixed(6)} s`;
  $('val_costop').innerText = (Math.abs(r.pricePerOp) < 1e-6)? r.pricePerOp.toExponential(3) : money(r.pricePerOp);
  $('infraMonthVal').innerText = money(r.infraMonth);
  $('infraYearVal').innerText = money(r.infraYear);
  renderDCs(r.nodesOpt, p.nodesPerDC);
  buildComparison(p, r);
  pushFullLog(`Preview: ops=${fmt(p.ops)}, nodeCap=${fmt(p.nodeCap)}, save=${p.savePct}%, nodesOpt=${r.nodesOpt}, time=${r.timeOpt.toFixed(6)}s, price/op=${r.pricePerOp.toExponential(6)}`);
}

/* ---------- render DC/nodes ---------- */
function renderDCs(nodes, nodesPerDC){
  const area = $('dcArea'); area.innerHTML = '';
  const dcs = Math.max(1, Math.ceil(nodes / nodesPerDC));
  let idx=0;
  for(let d=0; d<dcs; d++){
    const dc = document.createElement('div'); dc.className='dc';
    dc.innerHTML = `<div style="font-weight:700">DC ${d+1}</div>`;
    for(let n=0;n<nodesPerDC;n++){
      const node = document.createElement('div'); node.className='node';
      if(idx < nodes){ node.classList.add('busy'); node.title = 'node-'+(idx+1); }
      dc.appendChild(node); idx++;
    }
    area.appendChild(dc);
  }
  $('infraStatus').innerText = `Rendered ${nodes} nodes across ${Math.ceil(nodes/nodesPerDC)} DCs`;
  updateProgress(nodes, nodesPerDC);
}
function updateProgress(nodes, nodesPerDC){
  const totalSlots = Math.max(1, nodesPerDC * Math.ceil(nodes / nodesPerDC));
  const perc = Math.round((nodes / totalSlots) * 100);
  $('prog').style.width = perc + '%'; $('prog').innerText = perc + '%';
  $('eta').innerText = `ETA: ${(Math.max(0.01, (Math.random()*0.8 + 0.1))).toFixed(3)} s`;
}

/* ---------- Matrix / Smart Packing (greedy with packing factor) ---------- */
function generateMatrix(){
  const p = readParams(); const r = compute(p);
  const blocks = r.blocks;
  // per-node capacity in blocks (use 90% packing)
  const blocksPerNode = Math.max(1, Math.floor((r.effectiveCap * 0.9) / p.blockSize));
  const nodesAssigned = []; let rem = blocks;
  while(rem > 0){ const take = Math.min(blocksPerNode, rem); nodesAssigned.push(take); rem -= take; }
  // show table
  const area = $('matrixArea'); area.innerHTML = `<div class="small">Blocks: ${blocks.toLocaleString()}, perNodeLimitBlocks: ${blocksPerNode.toLocaleString()}, nodesAssigned: ${nodesAssigned.length}</div>`;
  const tbl = document.createElement('table'); tbl.className='table';
  tbl.innerHTML = '<thead><tr><th>Node</th><th>Assigned blocks</th><th>ops/node</th></tr></thead>';
  const tbody = document.createElement('tbody');
  nodesAssigned.forEach((b,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>node-${i+1}</td><td>${b} blocks</td><td>${(b * p.blockSize).toLocaleString()}</td>`;
    tbody.appendChild(tr);
    pushPackLog(`Assigned ${b} blocks -> node-${i+1}`);
  });
  tbl.appendChild(tbody); area.appendChild(tbl);
  pushFullLog(`Matrix generated: ${blocks} blocks -> ${nodesAssigned.length} nodes (blocks/node=${blocksPerNode})`);
}

/* packing log */
function pushPackLog(msg){ const el = $('packLog'); el.textContent = `${now()} — ${msg}\n` + el.textContent; }

/* ---------- ML loop (simulated optimizer increases savePct up to cap) ---------- */
let mlRunning=false, mlInterval=null;
function toggleML(){
  if(!mlRunning){
    mlRunning=true; $('btnML').innerText = 'Stop ML loop';
    mlInterval = setInterval(()=>{ mlStep(); }, 2500);
    pushFullLog('ML loop started');
  } else {
    mlRunning=false; $('btnML').innerText = 'Start ML loop';
    clearInterval(mlInterval);
    pushFullLog('ML loop stopped');
  }
}
function mlStep(){
  const el = $('savePct'); let v = Number(el.value);
  if(v < 65){
    // small realistic gains
    v = +(v + Math.max(0.5, v*0.025)).toFixed(2);
    el.value = Math.min(65, v);
    preview();
    updateMLChart(v);
    pushFullLog(`ML improved savePct -> ${el.value}%`);
  } else {
    // stop if reached
    toggleML();
  }
}

/* ---------- Charts (comparison & ML series) ---------- */
let cmpChart=null, mlChart=null, nodesChart=null;
function initCharts(){
  try{
    const ctx = $('cmpChart').getContext('2d');
    cmpChart = new Chart(ctx, {
      type:'bar',
      data:{labels:[],datasets:[{label:'Total $',data:[],backgroundColor:['#0b63c6','#3b82f6','#60a5fa','#93c5fd','#8fbfff']}]},
      options:{responsive:true,plugins:{legend:{display:false}}}
    });
  }catch(e){ console.warn('Chart init error', e); }
}
function updateMLChart(v){
  if(!mlChart){
    const c = document.createElement('canvas'); c.style.display='none'; document.body.appendChild(c); mlChart = true;
  }
}

/* ---------- Start Demo (predictive scaling animation) ---------- */
async function startDemo(){
  preview();
  const p = readParams(); const r = compute(p);
  pushFullLog(`Start demo: ops=${fmt(p.ops)}, nodeCap=${fmt(p.nodeCap)}, savePct=${p.savePct}%`);
  const baseline = await baselineTest(); pushFullLog(`Baseline microtest: ${baseline.toLocaleString()} ops/sec`);
  // timeline simulate
  const steps = 6; const timeline = [];
  for(let i=0;i<steps;i++) timeline.push(0.7 + Math.random()*1.3);
  pushFullLog(`Predicted load timeline: ${timeline.map(x=>x.toFixed(2)).join(', ')}`);
  for(let i=0;i<timeline.length;i++){
    const factor = timeline[i];
    const nodesNeeded = Math.max(1, Math.ceil(r.nodesOpt * factor));
    await animateScale(nodesNeeded);
    pushFullLog(`Step ${i+1}: factor=${factor.toFixed(2)}, nodesNeeded=${nodesNeeded}`);
    await sleep(700);
  }
  pushFullLog(`Demo finished. Final time estimate=${r.timeOpt.toFixed(6)} s, total price=${money(r.totalPrice)}`);
}

/* animate scale : marks nodes as busy */
function animateScale(target){
  return new Promise(res=>{
    const nodes = Array.from(document.querySelectorAll('.node'));
    nodes.forEach((n,i)=> {
      if(i < target) { n.classList.add('busy'); n.classList.remove('err'); }
      else { n.classList.remove('busy'); }
    });
    const totalSlots = Math.max(1, nodes.length);
    const perc = Math.round((target / totalSlots)*100);
    $('prog').style.width = perc + '%'; $('prog').innerText = perc + '%';
    $('eta').innerText = `ETA: ${(Math.random()*0.9+0.1).toFixed(3)} s`;
    setTimeout(res, 300);
  });
}

/* baseline microtest to show honest local throughput */
function baselineTest(){
  return new Promise(resolve=>{
    const ops = 120000;
    const start = performance.now();
    let s=0;
    for(let i=0;i<ops;i++) s += i % 13;
    const dur = (performance.now() - start)/1000;
    const opsSec = Math.max(1, Math.round(ops / Math.max(dur, 0.0001)));
    resolve(opsSec);
  });
}

/* ---------- Comparison table build ---------- */
function buildComparison(p, r){
  const tbody = $('cmpTable').querySelector('tbody'); tbody.innerHTML = '';
  addCmpRow(tbody, 'Cloudi (opt)', r.pricePerOp, r.totalPrice, r.timeOpt);
  // competitors
  for(const [name, data] of Object.entries(DEFAULTS.competitors)){
    const nodesC = Math.max(1, Math.ceil(p.ops / data.nodeCap));
    const infraC = nodesC * data.nodeCost + DEFAULTS.otherCost;
    const opsPerMonthC = data.nodeCap * nodesC * SECONDS_PER_MONTH;
    const costPerOpC = infraC / Math.max(1, opsPerMonthC);
    const pricePerOpC = costPerOpC * p.markup;
    const totalC = pricePerOpC * p.ops;
    const timeC = p.ops / (data.nodeCap * nodesC);
    addCmpRow(tbody, name, pricePerOpC, totalC, timeC);
  }
  // chart
  try{
    const labels = []; const totals = [];
    const rows = Array.from($('cmpTable').querySelectorAll('tbody tr'));
    rows.forEach(rw=>{
      const name = rw.cells[0].innerText;
      const total = parseFloat(rw.cells[2].innerText.replace(/[^0-9.-]+/g,"")) || 0;
      labels.push(name); totals.push(total);
    });
    if(cmpChart) { cmpChart.data.labels = labels; cmpChart.data.datasets[0].data = totals; cmpChart.update(); }
  }catch(e){ console.warn(e) }
}
function addCmpRow(tbody, name, costOp, total, time){
  const tr = document.createElement('tr');
  const costText = (Math.abs(costOp) < 1e-6) ? costOp.toExponential(3) : money(costOp);
  tr.innerHTML = `<td>${name}</td><td>${costText}</td><td>${money(total)}</td><td>${time.toFixed(3)}</td>`;
  tbody.appendChild(tr);
}

/* ---------- Storage fake ---------- */
const BUCKETS = {};
function createBucket(){
  const name = $('bucketName').value.trim();
  if(!name) return alert('Enter bucket name');
  if(BUCKETS[name]) return alert('Bucket exists');
  BUCKETS[name] = [];
  renderBuckets();
  pushFullLog(`Bucket created: ${name}`);
}
function renderBuckets(){
  const area = $('bucketsArea'); area.innerHTML = '';
  for(const [k,v] of Object.entries(BUCKETS)){
    const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
    div.innerHTML = `<div style="font-weight:700">${k}</div><div class="small">${v.length} objects • est ${(v.length*0.001).toFixed(4)} $/mo</div>
      <div style="margin-top:8px"><button class="btn secondary" onclick="uploadFake('${k}')">Upload fake file</button></div>`;
    area.appendChild(div);
  }
}
function uploadFake(bucket){
  BUCKETS[bucket].push({name:'file_'+(BUCKETS[bucket].length+1), size:Math.round(Math.random()*1000)});
  renderBuckets(); pushFullLog(`Uploaded fake file to ${bucket}`);
}

/* ---------- AI simulated ---------- */
function callAI(){
  const prompt = $('aiPrompt').value || 'Hello';
  $('aiResp').innerText = 'Processing...';
  const latency = 80 + Math.random()*300;
  setTimeout(()=>{ const resp = `Simulated answer to: "${prompt}". (latency ${Math.round(latency)} ms)`; $('aiResp').innerText = resp; pushFullLog(`AI inference: prompt="${prompt}", latency=${Math.round(latency)} ms`); }, latency);
}

/* ---------- Metrics, anomalies ---------- */
function generateMetrics(){
  const p = readParams();
  const p95 = Number($('p95').value || 250);
  const rps = Number($('rps').value || 100000);
  const txt = `p50: ${(p95*0.6).toFixed(1)} ms • p95: ${p95} ms • p99: ${(p95*1.6).toFixed(1)} ms • RPS: ${fmt(rps)}`;
  $('slaLog').textContent = `${now()} — metrics generated: ${txt}\n` + $('slaLog').textContent;
  pushFullLog(`Metrics: ${txt}`);
}
function simulateAnom(){ $('anomaly').innerText='true'; $('slaLog').textContent = `${now()} — anomaly: latency spike\n` + $('slaLog').textContent; pushFullLog('Anomaly simulated'); const nodes = document.querySelectorAll('.node'); nodes.forEach(n=>n.classList.add('err')); setTimeout(()=>{ nodes.forEach(n=>n.classList.remove('err')); $('anomaly').innerText='false'; pushFullLog('Auto-heal complete'); },2800); }
function resolveAnom(){ $('anomaly').innerText='false'; $('slaLog').textContent = `${now()} — anomaly resolved\n` + $('slaLog').textContent; pushFullLog('Anomaly resolved'); }

/* ---------- API demo ---------- */
function apiCall(){
  try{
    const req = JSON.parse($('apiReq') ? $('apiReq').value : '{"task":"batch"}');
    pushFullLog(`API request: ${JSON.stringify(req)}`);
    setTimeout(()=>{ const resp = { status:'accepted', estimate_s:(Math.random()*1).toFixed(3), nodes: Math.floor(Math.random()*6)+1 }; if($('apiResp')) $('apiResp').value = JSON.stringify(resp); pushFullLog(`API response: ${JSON.stringify(resp)}`); }, 400);
  }catch(e){ alert('Invalid JSON'); }
}

/* ---------- Logging ---------- */
function pushFullLog(msg){ const el = $('fullLog'); el.textContent = `${now()} — ${msg}\n` + el.textContent; }
function downloadLog(){
  const blob = new Blob([$('fullLog').textContent],{type:'text/plain'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='cloudi_log.txt'; a.click(); URL.revokeObjectURL(url);
}
function downloadJSON(){
  const p = readParams(); const r = compute(p);
  const obj = { params:p, result:r, ts: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='cloudi_preview.json'; a.click(); URL.revokeObjectURL(url);
}

/* ---------- utilities ---------- */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function resetDefaults(){ $('ops').value='1000000000'; $('nodeCap').value='200000000'; $('savePct').value='30'; $('markup').value='3'; $('blockSize').value='1000000'; preview(); pushFullLog('Defaults reset'); }
function copySummary(){ const text = `Cloudi summary\nops: ${$('ops').value}\nnodeCap: ${$('nodeCap').value}\nsave%: ${$('savePct').value}\nnodes: ${$('val_nodesopt').innerText}\ntime: ${$('val_time').innerText}\ncost/op: ${$('val_costop').innerText}`; navigator.clipboard?.writeText(text).then(()=> alert('Summary copied')); }

/* ---------- Language toggle (EN / RU) ---------- */
function setLang(lang){
  LANG = lang;
  // mark buttons
  $('btnEN').classList.toggle('active', LANG==='en');
  $('btnRU').classList.toggle('active', LANG==='ru');
  // main labels
  $('title').innerText = t('title');
  $('subtitle').innerText = t('subtitle');
  $('paramsTitle').innerText = t('mainParameters');
  $('lbl_ops').innerText = t('ops');
  $('lbl_nodecap').innerText = t('nodeCap');
  $('lbl_nodesdc').innerText = t('nodesPerDC');
  $('lbl_save').innerText = t('savePct');
  $('lbl_markup').innerText = t('markup');
  $('btnReset').innerText = t('reset');
  $('btnPreview').innerText = t('preview');
  $('btnStart').innerText = t('startDemo');
  $('computeTitle').innerText = t('computeTitle');
  $('packLogTitle').innerText = t('packLog');
  $('infraTitle').innerText = t('infraTitle');
  $('storageTitle').innerText = t('storageTitle');
  $('aiTitle').innerText = t('aiTitle');
  $('finopsTitle').innerText = t('finopsTitle');
  $('monitorTitle').innerText = t('monitoringTitle');
  $('btnMetrics').innerText = t('generateMetrics');
  $('btnAnom').innerText = t('simulateAnom');
  $('btnResolve').innerText = t('resolveAnom');
  $('btnDownloadJson').innerText = t('downloadJson');
  $('btnCopySummary').innerText = t('copySummary');
  $('btnDownloadLog').innerText = t('downloadLog');
  // quick summary header
  // other UI elements mostly static
}

/* ---------- initial wiring ---------- */
window.addEventListener('load', ()=>{
  // language default
  $('btnEN').addEventListener('click', ()=>setLang('en'));
  $('btnRU').addEventListener('click', ()=>setLang('ru'));
  setLang('en');

  // buttons
  $('btnPreview').addEventListener('click', preview);
  $('btnStart').addEventListener('click', startDemo);
  $('btnGenMatrix').addEventListener('click', generateMatrix);
  $('btnML').addEventListener('click', toggleML);
  $('btnCreateBucket').addEventListener('click', createBucket);
  $('btnAI').addEventListener('click', callAI);
  $('btnAIclear').addEventListener('click', ()=>{$('aiResp').innerText=''; $('aiPrompt').value='';});
  $('btnMetrics').addEventListener('click', generateMetrics);
  $('btnAnom').addEventListener('click', simulateAnom);
  $('btnResolve').addEventListener('click', resolveAnom);
  $('btnDownloadJson').addEventListener('click', downloadJSON);
  $('btnDownloadLog').addEventListener('click', downloadLog);
  $('btnReset').addEventListener('click', resetDefaults);
  $('btnCopySummary').addEventListener('click', copySummary);
  // API demo if present
  if($('btnApi')) $('btnApi').addEventListener('click', apiCall);

  // charts
  initCharts();
  preview();
  pushFullLog('Cloudi Full MVP ready (local browser simulation).');
});

/* init charts function defined earlier uses cmpChart variable */
function initCharts(){ initCharts = undefined; try{ const ctx = $('cmpChart').getContext('2d'); cmpChart = new Chart(ctx, { type:'bar', data:{labels:[],datasets:[{label:'Total $',data:[],backgroundColor:['#0b63c6','#3b82f6','#60a5fa','#93c5fd','#8fbfff']}]}, options:{responsive:true,plugins:{legend:{display:false}}} }); } catch(e){ console.warn(e); } }

</script>
</body>
</html>