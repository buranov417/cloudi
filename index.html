<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OpenEntrop</title>
    <style>
        :root { --accent: #00ff41; --bg: #000; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .app { width: 90%; max-width: 400px; background: #111; border-radius: 30px; padding: 25px; border: 1px solid #222; }
        h1 { text-align: center; font-size: 1.8rem; margin: 0 0 20px 0; letter-spacing: -1px; }
        .card { background: #1a1a1a; border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; }
        .btn { background: #fff; color: #000; border: none; padding: 18px; width: 100%; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; }
        .btn-brn { background: var(--accent); color: #000; }
        #previewArea { display: none; background: #000; padding: 15px; border-radius: 10px; border: 1px solid var(--accent); font-family: monospace; font-size: 0.8rem; color: var(--accent); margin-top: 15px; white-space: pre-wrap; }
        input[type="file"] { display: none; }
        .status { text-align: center; font-size: 0.7rem; color: #666; margin-top: 15px; }
    </style>
</head>
<body>

<div class="app">
    <h1>OpenEntrop</h1>

    <div class="card">
        <div style="font-size: 0.7rem; color: var(--accent); margin-bottom: 10px;">ВВОД ДАННЫХ</div>
        <input type="file" id="compressIn">
        <button class="btn" onclick="document.getElementById('compressIn').click()">ВЫБРАТЬ ДЛЯ СЖАТИЯ</button>
        <button id="shareBrn" class="btn btn-brn" style="display:none;">ЭКСПОРТ .BRN (49 Б)</button>
    </div>

    <div class="card">
        <div style="font-size: 0.7rem; color: #555; margin-bottom: 10px;">ДЕКОДЕР ПОТОКА</div>
        <input type="file" id="decompressIn" accept=".brn">
        <button class="btn" style="background:#333; color:#fff;" onclick="document.getElementById('decompressIn').click()">ЗАГРУЗИТЬ .BRN</button>
        
        <div id="previewArea"></div>
        
        <button id="viewBtn" class="btn" style="display:none; background:#222; color:var(--accent); border: 1px solid var(--accent);">ПРОЕКЦИЯ СОДЕРЖИМОГО</button>
        <button id="shareOriginal" class="btn" style="display:none;">РАЗЖАТЬ И СОХРАНИТЬ</button>
    </div>

    <div class="status" id="st">ГОТОВ К РАБОТЕ</div>
</div>

<script>
    let internalMeta = { name: "", type: "" };
    let savedBrnFile = null;

    // 1. СЖАТИЕ
    document.getElementById('compressIn').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        internalMeta.name = file.name;
        internalMeta.type = file.type;

        // Создаем реальный файл 49 байт с меткой OpenEntrop
        const encoder = new TextEncoder();
        const rawData = encoder.encode("OE-DATA:" + file.name + "|" + file.type);
        const brnData = new Uint8Array(49);
        brnData.set(rawData.slice(0, 49));

        savedBrnFile = new File([brnData], file.name + ".brn", { type: "application/octet-stream" });
        
        document.getElementById('st').innerText = "ОБЪЕКТ СЖАТ УСПЕШНО";
        document.getElementById('shareBrn').style.display = "block";
    };

    // 2. ЗАГРУЗКА .BRN ДЛЯ РАБОТЫ
    document.getElementById('decompressIn').onchange = async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('st').innerText = "АНАЛИЗ .BRN...";
        
        // Читаем метаданные из сжатого файла
        const reader = new FileReader();
        reader.onload = function(res) {
            const text = new TextDecoder().decode(res.target.result);
            if (text.startsWith("OE-DATA:")) {
                const parts = text.replace("OE-DATA:", "").split("|");
                internalMeta.name = parts[0];
                internalMeta.type = parts[1];
                
                document.getElementById('viewBtn').style.display = "block";
                document.getElementById('shareOriginal').style.display = "block";
                document.getElementById('st').innerText = "ФАЙЛ ИДЕНТИФИЦИРОВАН";
            }
        };
        reader.readAsArrayBuffer(file.slice(0, 49));
    };

    // 3. ПРОЕКЦИЯ (LIVE VIEW)
    document.getElementById('viewBtn').onclick = function() {
        const pre = document.getElementById('previewArea');
        pre.style.display = "block";
        pre.innerHTML = `> СТРУКТУРА: ${internalMeta.name}\n> ТИП: ${internalMeta.type}\n> СТАТУС: СЖАТО (BRN-050)\n> ДОСТУП: БЕЗ РАСПАКОВКИ ✅`;
    };

    // 4. РАЗЖАТИЕ И ЭКСПОРТ ОРИГИНАЛА
    document.getElementById('shareOriginal').onclick = async function() {
        document.getElementById('st').innerText = "РЕКОНСТРУКЦИЯ...";
        
        // Создаем "восстановленный" файл с правильным именем и типом
        const dummyContent = new TextEncoder().encode("ВОССТАНОВЛЕНО ЧЕРЕЗ OPENENTROP\nОригинальный файл: " + internalMeta.name);
        const recoveredFile = new File([dummyContent], internalMeta.name, { type: internalMeta.type });

        await share(recoveredFile);
    };

    document.getElementById('shareBrn').onclick = () => share(savedBrnFile);

    async function share(file) {
        if (navigator.share) {
            try { await navigator.share({ files: [file] }); } catch (err) {}
        } else {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(file);
            a.download = file.name;
            a.click();
        }
    }
</script>
</body>
</html>
