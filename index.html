<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cloudi — Full Cloud MVP (Investor Demo)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#f6f8fb;--card:#fff;--muted:#6b7280;--accent:#0b63c6;--ok:#16a34a;--warn:#f59e0b;--danger:#ef4444}
body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:18px;color:#0f172a}
.wrap{max-width:1150px;margin:0 auto;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 12px 40px rgba(2,6,23,0.08)}
h1{margin:0 0 6px;font-size:20px;text-align:center}
.lead{color:var(--muted);text-align:center;margin-bottom:12px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1;min-width:260px}
.card{background:#fbfdff;border:1px solid #eef3fb;padding:12px;border-radius:8px}
label{display:block;font-weight:600;margin-bottom:6px}
input[type=number],select,input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid #d6dce6;font-size:15px}
.btn{background:var(--accent);color:#fff;padding:10px;border-radius:8px;border:0;cursor:pointer;width:100%;font-weight:700}
.small{font-size:13px;color:var(--muted)}
.muted{color:var(--muted);font-size:13px}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{padding:6px;border-bottom:1px solid #eef3fb;text-align:left;font-size:14px}
.nodesGrid{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:12px}
.dc{width:110px;border-radius:8px;padding:8px;background:linear-gradient(180deg,#fff,#f8fbff);border:1px solid #e6eefb;text-align:center}
.node{height:14px;background:#e6eefb;border-radius:6px;margin:6px 0;transition:background .25s}
.node.busy{background:var(--ok)}
.progressOuter{background:#eef3fb;height:18px;border-radius:10px;overflow:hidden;margin-top:8px}
.progressInner{height:100%;background:var(--ok);width:0%;text-align:center;color:#fff;line-height:18px;font-size:12px}
.log{max-height:220px;overflow:auto;background:#0f172a;color:#fff;padding:8px;border-radius:6px;font-size:13px;white-space:pre-wrap}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.kv{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eef3fb}
.right{text-align:right}
.footer{margin-top:10px;text-align:center;color:var(--muted);font-size:13px}
.copyBtn{background:#222;color:#fff;padding:6px 10px;border-radius:6px;border:0;cursor:pointer}
@media(max-width:820px){.row{flex-direction:column}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Cloudi — Full Cloud MVP Simulator (Investor Demo)</h1>
  <div class="lead">Полная демонстрация: AI-Dispatcher, Smart-Packing, Elastic Scale, финансовая модель, сравнение с AWS/GCP/Azure. Всё прозрачно и объяснимо.</div>

  <!-- INPUTS -->
  <div class="row" style="margin-bottom:12px">
    <div class="col card">
      <label>Количество операций (operations)</label>
      <input id="ops" type="number" value="1000000000" min="1" />
      <div style="margin-top:8px" class="controls">
        <div style="flex:1">
          <label>Base node capacity (ops/sec)</label>
          <input id="nodeCapacity" type="number" value="200000000" />
        </div>
        <div style="width:130px">
          <label>Nodes / DC</label>
          <input id="nodesPerDC" type="number" value="4" />
        </div>
      </div>

      <div style="margin-top:8px" class="controls">
        <div style="flex:1">
          <label>Cloudi AI optimization (save %)</label>
          <input id="savePct" type="number" value="30" min="0" max="90" />
        </div>
        <div style="width:130px">
          <label>Cloudi markup ×</label>
          <input id="markup" type="number" value="3" step="0.1" min="1" />
        </div>
      </div>

      <div style="margin-top:10px" class="controls">
        <button class="btn" onclick="startDemo()">Start demo</button>
      </div>
      <div style="margin-top:8px" class="small muted">Примечание: baseline тест короткий и безопасный (не перегружает устройство).</div>
    </div>

    <!-- SUMMARY -->
    <div class="col card">
      <div style="font-weight:700">Ключевая сводка</div>
      <div class="small muted" id="summaryOps">—</div>
      <div style="margin-top:8px">
        <div class="kv"><div>Оптимальная нода (ops/sec)</div><div id="lblNodeCap">—</div></div>
        <div class="kv"><div>Nodes (raw)</div><div id="lblNodesRaw">—</div></div>
        <div class="kv"><div>Nodes (Cloudi)</div><div id="lblNodesOpt">—</div></div>
        <div class="kv"><div>Дата-центры (Cloudi)</div><div id="lblDCs">—</div></div>
        <div class="kv"><div>Время выполнения</div><div id="lblTime">—</div></div>
        <div class="kv"><div>Cost / op (Cloudi)</div><div id="lblCostOp">—</div></div>
        <div style="margin-top:8px"><button class="copyBtn" onclick="copySummary()">Скопировать сводку</button></div>
      </div>
    </div>
  </div>

  <!-- VISUALS + CHARTS -->
  <div class="row">
    <div class="col card">
      <h3 style="margin:4px 0">Инфраструктура — дата-центры и ноды</h3>
      <div class="small muted">Активные ноды подсвечены зелёным</div>
      <div id="dataCenters" class="nodesGrid" aria-hidden="false"></div>
      <div style="margin-top:8px" class="small muted" id="nodeStatus">—</div>
      <div style="margin-top:10px">
        <div class="progressOuter"><div id="progressBar" class="progressInner">0%</div></div>
        <div class="small muted" id="progressETA">ETA: —</div>
      </div>
      <div style="margin-top:12px">
        <h4 style="margin:6px 0">Лог операций (технический)</h4>
        <div id="log" class="log">Готово. Нажмите «Start demo». Лог содержит точные формулы и расчёты для инвестора/инженеров.</div>
      </div>
    </div>

    <div class="col card">
      <h3 style="margin:4px 0">Финансы и сравнение</h3>
      <div class="small muted">Себестоимость основана на инфрастуктуре; цена Cloudi = cost_per_op × markup</div>
      <table class="table">
        <tr><td>Стоимость ноды / мес</td><td id="ui_node_cost" class="right">420</td></tr>
        <tr><td>Доп. расходы / мес (network/monitoring)</td><td id="ui_other_cost" class="right">980</td></tr>
        <tr><td><b>Итого / мес (Cloudi)</b></td><td id="ui_total_month" class="right">—</td></tr>
        <tr><td><b>Итого / год</b></td><td id="ui_total_year" class="right">—</td></tr>
      </table>

      <div style="margin-top:8px">
        <canvas id="chartCost" height="200"></canvas>
      </div>
      <div style="margin-top:8px">
        <canvas id="chartTime" height="120"></canvas>
      </div>
    </div>
  </div>

  <div style="margin-top:12px" class="card">
    <h3 style="margin:6px 0">Сравнение по цене / времени (детально)</h3>
    <div class="small muted">Таблица даёт cost/op (USD) и итоговую цену для введённого объёма</div>
    <table class="table" id="comparisonTable">
      <tr><th>Платформа</th><th class="right">Cost / op (USD)</th><th class="right">Price for volume</th><th class="right">Time (s)</th></tr>
      <!-- rows will be inserted -->
    </table>
  </div>

  <div class="footer">Формулы: nodes = ceil(ops / node_capacity). Для Cloudi: effective_capacity = node_capacity * (1 + savePct/100) (smart packing). cost_per_op = infra_month / (capacity_per_month). Все шаги логируются и объясняются в логе.</div>
</div>

<script>
/* ---------------- CONFIG / DEFAULTS ---------------- */
const DEFAULT_NODE_COST = 420; // $ per node per month
const DEFAULT_OTHER_COST = 980; // network + monitoring etc per month
const DEFAULT_COMPETITORS = {
  AWS:  { nodeCapacity: 180_000_000, nodeCost: 500 },
  GCP:  { nodeCapacity: 190_000_000, nodeCost: 480 },
  Azure:{ nodeCapacity: 175_000_000, nodeCost: 520 }
};
const SECONDS_PER_MONTH = 30*24*3600;

/* ----------------- UTIL ----------------- */
function log(msg){
  const el = document.getElementById('log');
  const ts = new Date().toLocaleTimeString();
  el.textContent = `${ts} — ${msg}\n` + el.textContent;
}
function fmt(n){ if(typeof n!=='number') return n; return n.toLocaleString(); }
function money(n){
  if(n===0) return '$0.00';
  if(Math.abs(n) < 0.000001) return n.toExponential(3);
  return '$' + Number(n).toLocaleString(undefined,{maximumFractionDigits:6});
}

/* ----------- baseline microbenchmark (small safe test) ---------- */
async function runBaselineTest(){
  // run a small workload and measure ops/sec on device
  // keep it very small to avoid blocking too long on phone
  return new Promise(resolve=>{
    const testOps = 300000; // 300k quick operations
    const start = performance.now();
    let x=0;
    for(let i=0;i<testOps;i++){ x += (i%5); } // trivial op
    const dur = (performance.now()-start)/1000;
    const opsPerSec = testOps / Math.max(dur,0.0001);
    // log
    log(`Baseline microtest: ${testOps} ops in ${dur.toFixed(3)}s -> ${Math.round(opsPerSec).toLocaleString()} ops/sec`);
    resolve(Math.max(1, Math.round(opsPerSec)));
  });
}

/* ---------------- main demo routine ---------------- */
let chartCost=null, chartTime=null;
function initCharts(){
  const ctx = document.getElementById('chartCost').getContext('2d');
  if(chartCost) chartCost.destroy();
  chartCost = new Chart(ctx, {
    type:'bar',
    data:{labels:[], datasets:[{label:'Total $', data:[], backgroundColor:['#0b63c6','#3b82f6','#60a5fa','#93c5fd']}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
  });
  const ctx2 = document.getElementById('chartTime').getContext('2d');
  if(chartTime) chartTime.destroy();
  chartTime = new Chart(ctx2, {
    type:'bar',
    data:{labels:[], datasets:[{label:'Time (s)', data:[], backgroundColor:['#16a34a','#f59e0b','#ef4444','#a855f7']}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
  });
}

async function startDemo(){
  initCharts();
  const ops = Math.max(1, Math.floor(Number(document.getElementById('ops').value) || 1));
  const nodeCapacityInput = Math.max(1, Math.floor(Number(document.getElementById('nodeCapacity').value) || 200000000));
  const nodesPerDC = Math.max(1, Math.floor(Number(document.getElementById('nodesPerDC').value) || 4));
  const savePct = Math.max(0, Math.min(90, Number(document.getElementById('savePct').value) || 30));
  const markup = Math.max(1, Number(document.getElementById('markup').value) || 3);

  log(`Starting demo for ${fmt(ops)} ops. Node cap=${fmt(nodeCapacityInput)} ops/sec, save=${savePct}%, markup=${markup}x`);

  document.getElementById('summaryOps').innerText = `Запрошено: ${fmt(ops)} операций`;

  // baseline (device) measurement
  const baselineDevice = await runBaselineTest(); // ops/sec on device for trivial work
  log(`Device baseline measured: ${fmt(baselineDevice)} ops/sec (used for authenticity)`);

  // But we use configured nodeCapacity as authoritative for server node (vCPU)
  const nodeCapacity = nodeCapacityInput;

  // RAW nodes (no optimization)
  const nodesRaw = Math.max(1, Math.ceil(ops / nodeCapacity));
  // Cloudi optimization: treat it as effective capacity increase or nodes reduction via smart packing.
  // Two equivalent ways: increase effective capacity per node, or divide nodes by factor.
  const effectiveCapacity = nodeCapacity * (1 + savePct/100); // how much effective ops/sec per node after optimization
  const nodesOpt = Math.max(1, Math.ceil(ops / effectiveCapacity));

  // date centers
  const dcsOpt = Math.ceil(nodesOpt / nodesPerDC);

  // times
  const timeRaw = ops / (nodeCapacity * nodesRaw);
  const timeOpt = ops / (effectiveCapacity * nodesOpt);

  // clamp times for UX: show at least 0.2s, max 120s
  const visibleTimeRaw = Math.max(0.02, Math.min(120, timeRaw));
  const visibleTimeOpt = Math.max(0.02, Math.min(120, timeOpt));

  // infra costs
  const nodeCost = DEFAULT_NODE_COST;
  const otherCost = DEFAULT_OTHER_COST;
  const infraCostOptMonth = nodesOpt * nodeCost + otherCost;
  const infraCostOptYear = infraCostOptMonth * 12;

  // capacity per month (ops)
  const opsPerMonthOpt = effectiveCapacity * nodesOpt * SECONDS_PER_MONTH;
  const costPerOpOpt = infraCostOptMonth / Math.max(1, opsPerMonthOpt);

  // Cloudi price (charging)
  const pricePerOpCloudi = costPerOpOpt * markup;
  const totalPriceCloudi = pricePerOpCloudi * ops;

  // competitors calculation
  const comps = {};
  for(const [k,v] of Object.entries(DEFAULT_COMPETITORS)){
    const nodesComp = Math.max(1, Math.ceil(ops / v.nodeCapacity));
    const dcsComp = Math.ceil(nodesComp / nodesPerDC);
    const infraCompMonth = nodesComp * v.nodeCost + otherCost;
    const opsPerMonthComp = v.nodeCapacity * nodesComp * SECONDS_PER_MONTH;
    const costPerOpComp = infraCompMonth / Math.max(1, opsPerMonthComp);
    const priceComp = costPerOpComp * markup; // assume same markup for fair comparison
    const totalComp = priceComp * ops;
    const timeComp = ops / (v.nodeCapacity * nodesComp);
    comps[k] = { nodes: nodesComp, dcs: dcsComp, infraMonth: infraCompMonth, costPerOp: costPerOpComp, pricePerOp: priceComp, totalPrice: totalComp, time: timeComp };
  }

  // update UI summary
  document.getElementById('lblNodeCap').innerText = fmt(nodeCapacity);
  document.getElementById('lblNodesRaw').innerText = fmt(nodesRaw);
  document.getElementById('lblNodesOpt').innerText = fmt(nodesOpt);
  document.getElementById('lblDCs').innerText = fmt(dcsOpt);
  document.getElementById('lblTime').innerText = `${visibleTimeOpt.toFixed(4)} s (Cloudi) · raw ${visibleTimeRaw.toFixed(4)} s`;
  document.getElementById('lblCostOp').innerText = `${money(pricePerOpCloudi)} per op`;

  document.getElementById('ui_node_cost').innerText = `$${nodeCost}`;
  document.getElementById('ui_other_cost').innerText = `$${otherCost}`;
  document.getElementById('ui_total_month').innerText = money(infraCostOptMonth);
  document.getElementById('ui_total_year').innerText = money(infraCostOptYear);

  // build DC/nodes UI
  const dcContainer = document.getElementById('dataCenters');
  dcContainer.innerHTML = '';
  let totalNodesToRender = nodesOpt;
  for(let d=0; d<dcsOpt; d++){
    const dc = document.createElement('div'); dc.className='dc';
    dc.innerHTML = `<div style="font-weight:700">DC ${d+1}</div>`;
    for(let n=0;n<nodesPerDC;n++){
      const nodeEl = document.createElement('div'); nodeEl.className='node';
      // mark active only for first nodesOpt nodes
      const idx = d*nodesPerDC + n;
      if(idx < nodesOpt) nodeEl.dataset.active='1'; else nodeEl.dataset.active='0';
      dc.appendChild(nodeEl);
    }
    dcContainer.appendChild(dc);
  }

  // animate processing across active nodes
  const activeNodes = Array.from(document.querySelectorAll('.node')).filter(x=>x.dataset.active==='1');
  const totalActive = Math.max(1, activeNodes.length);
  document.getElementById('nodeStatus').innerText = `Cloudi AI dispatcher распределяет нагрузку по ${totalActive} нодам (smart-packing).`;

  // progress animation: break visibleTimeOpt into steps = totalActive, show each node busy in round-robin
  const progressBar = document.getElementById('progressBar');
  const progressETA = document.getElementById('progressETA');
  let step = 0;
  const steps = totalActive;
  const stepTime = Math.max(50, Math.floor((visibleTimeOpt*1000) / steps)); // ms per step
  progressBar.style.width = `0%`; progressBar.textContent='0%';
  progressETA.textContent = `ETA: ${(visibleTimeOpt).toFixed(3)} s`;
  log(`Calculated: nodesOpt=${nodesOpt}, dcsOpt=${dcsOpt}, timeOpt=${visibleTimeOpt.toFixed(6)}s, infraMonth=${infraCostOptMonth}`);

  // clear any leftover busy classes
  activeNodes.forEach(n=>n.classList.remove('busy'));

  let animCount = 0;
  const anim = setInterval(()=>{
    const idx = animCount % totalActive;
    // set active
    activeNodes.forEach((el,i)=> el.classList.toggle('busy', i===idx));
    const perc = Math.min(100, Math.round(((animCount+1)/steps)*100));
    progressBar.style.width = `${perc}%`; progressBar.textContent = `${perc}%`;
    progressETA.textContent = `ETA: ${(Math.max(0,(steps-animCount-1))*stepTime/1000).toFixed(2)} s`;
    animCount++;
    if(animCount>=steps){
      // finish after one full round + small delay for realism
      setTimeout(()=>{
        activeNodes.forEach(el=>el.classList.remove('busy'));
        progressBar.style.width='100%'; progressBar.textContent='100%';
        progressETA.textContent = `Done in ${(visibleTimeOpt).toFixed(3)} s`;
        log(`Processing finished: Cloudi processed ${fmt(ops)} ops in ${(visibleTimeOpt).toFixed(6)} s (simulated).`);
        clearInterval(anim);
      }, 250);
    }
  }, stepTime);

  // build comparison table and charts
  const compTable = document.getElementById('comparisonTable');
  // clear rows except header
  while(compTable.rows.length>1) compTable.deleteRow(1);
  const rowsForChartCost = [];
  const labelsCost = [];
  const dataCost = [];
  const labelsTime = [];
  const dataTime = [];

  // Cloudi row
  addCompRow('Cloudi (optimized)', pricePerOpCloudi, totalPriceCloudi, visibleTimeOpt);
  labelsCost.push('Cloudi'); dataCost.push(Number(totalPriceCloudi.toFixed(2)));
  labelsTime.push('Cloudi'); dataTime.push(Number(visibleTimeOpt.toFixed(3)));

  // competitors
  for(const [k,v] of Object.entries(comps)){
    addCompRow(k, v.pricePerOp, v.totalPrice, Math.min(120, v.time));
    labelsCost.push(k); dataCost.push(Number(v.totalPrice.toFixed(2)));
    labelsTime.push(k); dataTime.push(Number(Math.min(120, v.time).toFixed(3)));
  }

  // update charts
  chartCost.data.labels = labelsCost; chartCost.data.datasets[0].data = dataCost; chartCost.update();
  chartTime.data.labels = labelsTime; chartTime.data.datasets[0].data = dataTime; chartTime.update();

  function addCompRow(name, costPerOp, totalPrice, timeSeconds){
    const r = compTable.insertRow(-1);
    const c1 = r.insertCell(0); c1.textContent = name;
    const c2 = r.insertCell(1); c2.className='right'; c2.textContent = (Math.abs(costPerOp) < 0.0000001) ? costPerOp.toExponential(3) : money(costPerOp);
    const c3 = r.insertCell(2); c3.className='right'; c3.textContent = money(totalPrice);
    const c4 = r.insertCell(3); c4.className='right'; c4.textContent = timeSeconds.toFixed(3);
  }

  // final explanation in log
  log(`Cloudi price per op: ${pricePerOpCloudi.toExponential(6)} ; total price: ${money(totalPriceCloudi)}; infra month: ${money(infraCostOptMonth)}`);
  log(`Comparison prepared with markup ${markup}x; device baseline: ${fmt(baselineDevice)} ops/sec (for demo authenticity)`);
}

/* copy summary */
function copySummary(){
  const s = [
    document.getElementById('summaryOps').innerText,
    `Node cap: ${document.getElementById('lblNodeCap').innerText}`,
    `Nodes raw: ${document.getElementById('lblNodesRaw').innerText}`,
    `Nodes Cloudi: ${document.getElementById('lblNodesOpt').innerText}`,
    `DCs Cloudi: ${document.getElementById('lblDCs').innerText}`,
    `Time Cloudi: ${document.getElementById('lblTime').innerText}`,
    `Cost/op Cloudi: ${document.getElementById('lblCostOp').innerText}`,
  ].join('\n');
  navigator.clipboard?.writeText(s).then(()=> alert('Сводка скопирована в буфер обмена'), ()=> alert('Не удалось скопировать'));
}

/* init charts on load */
window.addEventListener('load', ()=> {
  const ctx = document.getElementById('chartCost').getContext('2d');
  window.chartCost = new Chart(ctx, {type:'bar',data:{labels:[],datasets:[{label:'Total $',data:[],backgroundColor:['#0b63c6','#3b82f6','#60a5fa','#93c5fd']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
  const ctx2 = document.getElementById('chartTime').getContext('2d');
  window.chartTime = new Chart(ctx2, {type:'bar',data:{labels:[],datasets:[{label:'Time (s)',data:[],backgroundColor:['#16a34a','#f59e0b','#ef4444','#a855f7']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
  log('Ready. Configure parameters and press Start demo.');
});
</script>
</body>
</html>